import streamlit as st
from datetime import date
import time
import random

# 1. 頁面配置 (必須放在最頂端)
st.set_page_config(page_title="Aroma's Secret Lab", layout="centered")

# ==========================================
# 數據庫 A：78 種香味與感性描述
# ==========================================
scent_map = {
    # --- 前調 (Top Notes) - 共 20 種 ---
    "前調 芳香 01": "富家千金 (小豆蔻/烏龍茶)",
    "前調 芳香 02": "夏天的風 (羅勒/百里香)",
    "前調 芳香 03": "野花 (小豆蔻/含羞草)",
    "前調 芳香 04": "肆意奔放 (小豆蔻/馬郁蘭)",
    "前調 芳香 05": "鄉愁 (梔子花/綠葉/甘草)",
    "前調 芳香 06": "茶樹 (茶樹)",
    "前調 芳香 07": "薄荷 (薄荷)",
    "前調 芳香 08": "馬鞭草 (馬鞭草)",
    "前調 芳香 09": "綠茶 (綠茶)",
    "前調 柑橘 01": "花園 (橘子/檸檬/開心果)",
    "前調 柑橘 02": "記憶蜜糖 (橘子/桃子)",
    "前調 柑橘 03": "寂靜秋夜 (胡蘿蔔/番茄/橙子)",
    "前調 柑橘 04": "氣泡水 (葡萄柚/橘子)",
    "前調 柑橘 05": "海邊漫步 (橙子/檸檬)",
    "前調 柑橘 06": "海灘 (佛手柑/檸檬/香橙)",
    "前調 柑橘 07": "純真 (橙子/茉莉/琥珀)",
    "前調 柑苔 01": "晨間森林 (無花果木/香根草)",
    "前調 柑苔 02": "信仰 (橘子/麝香/苦橙葉)",
    "前調 柑苔 03": "清新 (葡萄柚/橡木苔)",
    "前調 柑苔 04": "苔蘚 (苔蘚)",

    # --- 中調 (Middle Notes) - 共 34 種 ---
    "中調 果香 01": "夏日莊園 (柑橘/無花果)",
    "中調 果香 02": "純粹 (香瓜/橘子/黃瓜)",
    "中調 果香 03": "甜美 (草莓/梨/蜜橘)",
    "中調 果香 04": "情竇初開 (紅漿果/糖)",
    "中調 果香 05": "撒丁島 (橙花油/檸檬)",
    "中調 果香 06": "仲夏花園 (紅蘋果/玫瑰)",
    "中調 果香 07": "酸甜軟妹 (黑加侖/菠蘿/焦糖)",
    "中調 果香 08": "地中海 (香豌豆/檸檬/焦糖)",
    "中調 果香 09": "海邊微風 (黃葵/鹽)",
    "中調 果香 10": "咖啡廳 (甜蘋果/香橙花/香草)",
    "中調 果香 11": "柑橘 (柑橘)",
    "中調 果香 12": "檸檬 (檸檬)",
    "中調 果香 13": "百香果 (百香果)",
    "中調 果香 14": "青瓜 (青瓜)",
    "中調 果香 15": "青蘋果 (青蘋果)",
    "中調 花香 01": "白襯衫 (薰衣草/橙花)",
    "中調 花香 02": "優雅女人 (晚香玉/茉莉花)",
    "中調 花香 03": "雨後花園 (玫瑰/依蘭)",
    "中調 花香 04": "靜謐花園 (玫瑰/茉莉)",
    "中調 花香 05": "初春 (玫瑰/蜂蜜)",
    "中調 花香 06": "春意盎然 (茉莉/綠葉)",
    "中調 花香 07": "梨子酒 (梨/小蒼蘭)",
    "中調 花香 08": "森林小屋 (薰衣草/肉豆蔻)",
    "中調 花香 09": "稻香 (橙花/香草)",
    "中調 花香 10": "異域風情 (晚香玉/依蘭)",
    "中調 花香 11": "優雅 (茉莉/蘭花/李子)",
    "中調 花香 12": "薰衣草 (薰衣草)",
    "中調 花香 13": "夜來香 (夜來香)",
    "中調 花香 14": "梔子花 (梔子花)",
    "中調 花香 15": "依蘭 (依蘭)",
    "中調 花香 16": "玫瑰 (玫瑰)",
    "中調 花香 17": "風鈴草 (風鈴草)",
    "中調 花香 18": "茉莉 (茉莉)",
    "中調 花香 19": "桂花 (桂花)",

    # --- 後調 (Base Notes) - 共 24 種 ---
    "後調 東方 01": "雨落幽然 (苦橙/琥珀)",
    "後調 東方 02": "烏龍茶 (茶葉/香根草)",
    "後調 東方 03": "新倫敦男 (肉桂/煙草/橡木苔)",
    "後調 東方 04": "古老書店 (冬加豆)",
    "後調 東方 05": "西西里島 (杏仁/香草/麝香)",
    "後調 東方 06": "陽光 (紫羅蘭/香草/麝香)",
    "後調 東方 07": "高山微風 (迷迭香/廣藿香)",
    "後調 東方 08": "冬日壁爐 (琥珀/麝香)",
    "後調 東方 09": "荷爾蒙 (花椒/廣藿香)",
    "後調 東方 10": "法國紳士 (橘子/檀香木)",
    "後調 東方 11": "梅糖 (梨/杏仁/香草)",
    "後調 木質 01": "冬日松林 (雪松/麝香)",
    "後調 木質 02": "沉靜森林 (白松香/檀香)",
    "後調 木質 03": "沉穩 (莞荽/香根草/雪松木)",
    "後調 木質 04": "龍涎 (龍涎/琥珀/木質)",
    "後調 木質 05": "雪松 (雪松)",
    "後調 木質 06": "空靈 (麝香/沉香)",
    "後調 木質 07": "晨間山風 (香草/沉香)",
    "後調 木質 08": "寺廟 (黑胡椒/檀木)",
    "後調 木質 09": "雲霧 (迷迭香/樟木)",
    "後調 木質 10": "故鄉 (沉香/廣藿香)",
    "後調 木質 11": "焚香 (沉香/巴西紅木)",
    "後調 木質 12": "月光柏木 (苦橙/柏樹)",
    "後調 木質 13": "檀香 (檀香)"
}
scent_descriptions = {
    # --- 前調 (Top Notes) ---
    "前調 芳香 01": "清冷烏龍與辛香小豆蔻碰撞，彷彿在霧氣繚繞的清晨茶山中獨坐。",
    "前調 芳香 02": "清新的羅勒與百里香交織，如同漫步在灑滿午後陽光的歐式香草園。",
    "前調 芳香 03": "含羞草的粉感與小豆蔻的暖意，像是踏入一片開滿無名野花的靜謐荒野。",
    "前調 芳香 04": "馬郁蘭的藥草氣息帶動感性，散發出一種無拘無束、肆意奔放的自由感。",
    "前調 芳香 05": "梔子花的潔白與綠葉的清苦，勾起記憶中那抹淡淡的、帶有草木香的鄉愁。",
    "前調 芳香 06": "強勁的茶樹氣息，像是雨後森林般清冽，帶給靈魂最徹底的淨化與甦醒。",
    "前調 芳香 07": "極致清涼的薄荷，瞬間點燃感官，彷彿在炎熱夏日喝下一口冰鎮泉水。",
    "前調 芳香 08": "馬鞭草的檸檬清香，帶來輕盈跳躍的活力，讓心情隨之飛揚。",
    "前調 芳香 09": "優雅的綠茶清芬，如同細雨過後的竹林，安靜、內斂且充滿禪意。",
    "前調 柑橘 01": "橘子與檸檬的酸甜，伴隨開心果的微香，像是一場色彩繽紛的花園派對。",
    "前調 柑橘 02": "多汁的桃子融入柑橘，營造出被蜜糖包裹的童年記憶，甜而不膩。",
    "前調 柑橘 03": "胡蘿蔔與橙子的奇妙結合，如同在秋日的寂靜黃昏，看落葉鋪滿大地。",
    "前調 柑橘 04": "清爽噴湧的葡萄柚氣泡，充滿爆發力的酸甜，瞬間提振精神。",
    "前調 柑橘 05": "沁人心脾的清爽柑橘，彷彿光著腳在海邊漫步，感受浪花輕拍腳踝。",
    "前調 柑橘 06": "佛手柑的輕盈與檸檬的海風感，讓思緒飄向遙遠的地中海沙灘。",
    "前調 柑橘 07": "橘子與純真茉莉的邂逅，像是微風中搖曳的白色裙擺，純淨且動人。",
    "前調 柑苔 01": "無花果木與香根草的結合，如同清晨走進原始森林，腳下是潮濕的泥土。",
    "前調 柑苔 02": "苦橙葉與麝香的深層共鳴，代表一種內在的堅定，如同朝聖者的信仰。",
    "前調 柑苔 03": "橡木苔與葡萄柚的冷靜感，像是一陣穿透迷霧的清香，帶來極致的清醒。",
    "前調 柑苔 04": "潮濕的苔蘚氣息，帶有一絲泥土的芬芳，讓人不自覺地向大自然深處探索。",

    # --- 中調 (Middle Notes) ---
    "中調 果香 01": "柑橘與無花果的暖甜，彷彿置身於南法莊園，享受悠閒的午後時光。",
    "中調 果香 02": "甜美的香瓜與清涼黃瓜，純粹得不帶一絲雜質，讓感官瞬間降溫。",
    "中調 果香 03": "草莓與蜜橘的香甜，像是初戀時咬下的第一口水果糖，滿口芳甜。",
    "中調 果香 04": "紅漿果的酸甜與糖分的結合，譜寫出一曲關於情竇初開的甜蜜樂章。",
    "中調 果香 05": "橙花油與檸檬的清冽，帶您飛向撒丁島，感受海風中的清爽果味。",
    "中調 果香 06": "紅蘋果與玫瑰的交融，如同在仲夏的花園中，邂逅最燦爛的盛放。",
    "中調 果香 07": "黑加侖與菠蘿的奔放，帶有一點焦糖的甜潤，展現出酸甜軟妹的俏皮感。",
    "中調 果香 08": "香豌豆與焦糖的層次感，像是地中海陽光下的午後茶點，慵懶而滿足。",
    "中調 果香 09": "黃葵與鹽的結合，如同海邊拂過的微風，帶有一絲不露痕跡的迷人魅力。",
    "中調 果香 10": "香橙花與香草交織出的溫暖甜香，彷彿冬日午後，坐在瀰漫香氣的咖啡廳。",
    "中調 花香 01": "薰衣草與橙花的潔淨，像是一件剛在陽光下晾乾的白襯衫，讓人倍感舒心。",
    "中調 花香 02": "晚香玉與茉莉的濃郁花香，自信而優雅，綻放出成熟女性的迷人光彩。",
    "中調 花香 03": "玫瑰與依蘭在雨後濕潤的氣息中綻放，如同走入一座神祕且幽靜的庭園。",
    "中調 花香 04": "玫瑰與茉莉的經典結合，安靜地盛開在心田，營造出一份內心的靜謐。",
    "中調 花香 05": "蜂蜜包裹著初春的玫瑰，柔情似水，緩緩釋放出春天最溫柔的訊息。",
    "中調 花香 06": "茉莉與翠綠葉片的氣息，生機盎然，彷彿看見春芽在枝頭輕輕顫動。",
    "中調 花香 07": "梨與小蒼蘭交織出的微醺氣息，像是倒出一杯清透的梨子酒，晶瑩動人。",
    "中調 花香 08": "薰衣草與肉豆蔻的溫暖辛香，如同躲進大雪中的森林小屋，爐火正旺。",
    "中調 花香 09": "橙花與香草的清甜，帶有一絲稻米的溫潤感，是豐收季節最安心的問候。",
    "中調 花香 10": "依蘭與晚香玉的異國風情，神祕且大膽，領您踏上一場華麗的冒險之旅。",
    "中調 花香 11": "蘭花與李子的交織，優雅而不失靈動，在舉手投足間流露出高級質感。",
    "中調 花香 19": "清甜入骨的桂花香，彷彿在某個秋夜的街角，偶遇了一場關於月光的夢。",

    # --- 後調 (Base Notes) ---
    "後調 東方 01": "苦橙與琥珀的碰撞，如同細雨落下後的幽然森林，帶著神祕的暖意。",
    "後調 東方 02": "茶葉與香根草的交融，帶有一種沉澱過後的文雅，是靈魂深處的冷靜。",
    "後調 東方 03": "肉桂與煙草的成熟韻味，如同在倫敦街頭漫步的高雅男士，從容且自信。",
    "後調 東方 04": "冬加豆的醇厚氣息，像是走進一間塞滿舊書的老書店，時間在此凝固。",
    "後調 東方 05": "杏仁、香草與麝香的包裹，如同西西里島的暖陽，溫潤而令人陶醉。",
    "後調 東方 06": "紫羅蘭與香草的輕柔呼吸，像是在陽光下舒展身體，感受生命最柔軟的時刻。",
    "後調 東方 07": "迷迭香與廣藿香的交纏，如高山頂峰掠過的疾風，清澈且具有穿透力。",
    "後調 東方 08": "琥珀與麝香營造出爐火般的溫度，如同在寒冬中，靠近最溫暖的壁爐。",
    "後調 東方 09": "花椒的微辛與廣藿香的深沉，釋放出強烈的荷爾蒙感，危險且誘人。",
    "後調 東方 10": "橘子與檀香木的優雅結合，是一位風度翩翩的法國紳士，低調且尊貴。",
    "後調 東方 11": "梨與香草的甜糯感，像是童年最愛的那顆梅糖，在舌尖緩緩化開。",
    "後調 木質 01": "雪松與麝香的冷暖對比，如同銀裝素裹的松林，清冷而又透著生機。",
    "後調 木質 02": "白松香與檀香的沈靜，如同進入一片無人打擾的森林深處，呼吸著自由。",
    "後調 木質 03": "香根草與雪松的紮實感，賦予心靈一種無與倫比的沉穩與定力。",
    "後調 木質 04": "龍涎與琥珀的交織，如同時間雕琢而成的樹脂，閃爍著大地的光輝。",
    "後調 木質 05": "純粹的雪松香氣，潔淨且筆直，是靈魂最不容妥協的底色。",
    "後調 木質 06": "麝香與沉香的空靈結合，彷彿跨越時空的呼吸，縹緲且神聖。",
    "後調 木質 07": "香草與沉香的甜苦交織，如同晨間穿透山風的第一縷陽光，充滿希望。",
    "後調 木質 08": "檀木與黑胡椒的莊嚴感，像是踏入靜謐的寺廟，浮躁瞬間消散無蹤。",
    "後調 木質 09": "迷迭香與樟木的清冽，如雲霧繚繞的山巔，清冷且讓人心曠神怡。",
    "後調 木質 10": "沉香與廣藿香的厚重感，是記憶中無法抹去的故鄉記憶，深情且踏實。",
    "後調 木質 11": "沉香與巴西紅木的激盪，在焚香的縈繞中，展現出一種超脫塵世的靜謐。",
    "後調 木質 12": "柏樹與苦橙的堅韌，如同在月光下挺拔的柏樹，守護著夜晚的安寧。",
    "後調 木質 13": "純淨的檀香，溫潤如玉，是時間沉澱下來的最溫柔的底氣。"
}

# ==========================================
# 數據庫 B：命理、人格與比例邏輯
# ==========================================
zodiac_db = {
    "白羊座": "勇氣與活力的開拓者。擁有一往無前的能量，性格純粹、直率。",
    "金牛座": "質感生活的守護者。感官敏銳，追求穩定與極致的美感。",
    "雙子座": "好奇靈動的思想傳播者。思維跳躍、熱愛溝通，靈魂中藏著風的自由。",
    "巨蟹座": "細膩療癒的情感溫室。守護內在的安全感，感性且具備極強共情力。",
    "獅子座": "自信領導的創造力中心。擁有強大的意志與溫暖的慷慨，如太陽般耀眼。",
    "處女座": "追求完美的秩序工匠。心思縝密，具備冷靜的觀察力與純淨靈魂底色。",
    "天秤座": "優雅平衡的協調藝術家。追求和諧與美感，處事從容不迫。",
    "天蠍座": "神秘洞察的靈魂探測器。情感深邃、意志堅定，氣質高冷且極具磁性。",
    "射手座": "冒險自由的真理追尋者。熱愛遠方與探索，擁有一種不被世俗拘束的氣場。",
    "摩羯座": "踏實責任的攀登先鋒。擁有驚人的耐力與野心，氣質沉著冷靜。",
    "水瓶座": "獨立革新的未來思想家。思維超前、特立獨行，散發著智慧的獨特電波。",
    "雙魚座": "靈性藝術的夢想編織者。靈魂充滿詩意，感性且慈悲。"
}

element_traits = {
    "水": "【水能量：靈性智慧】具備極強的適應力與穿透力，性格細膩包容。",
    "木": "【木能量：成長生機】代表生命力，性格仁慈正直，擁有自我突破的渴望。",
    "火": "【火能量：熱情熱烈】散發溫暖，性格開朗重視禮儀，具強大感染力。",
    "金": "【金能量：剛毅精準】擁有決斷力，性格冷靜正直，追求效率與核心價值。",
    "土": "【土能量：厚重穩定】象徵大地的包容，性格沉穩踏實，是值得信賴的依靠。"
}

zodiac_animal_db = {
    "鼠": "機敏俐落，觀察細微。", "牛": "勤奮穩重，意志力強。", "虎": "威猛果敢，具開創精神。",
    "兔": "文雅溫柔，心思縝密。", "龍": "宏偉不凡，領袖魅力。", "蛇": "冷靜沉著，直覺靈敏。",
    "馬": "奔放熱情，熱愛自由。", "羊": "體貼仁慈，具藝術感。", "猴": "聰明變通，充滿創意。",
    "雞": "負責果斷，講求紀律。", "狗": "忠誠正義，值得信賴。", "豬": "真誠厚道，性情豁達。"
}

zodiac_elements = {"鼠": "水", "豬": "水", "虎": "木", "兔": "木", "蛇": "火", "馬": "火", "猴": "金", "雞": "金", "牛": "土", "龍": "土", "羊": "土", "狗": "土"}

mbti_db = {
    "INTJ (建築師)": {
        "top": ["前調 芳香 01", "前調 柑苔 01", "前調 芳香 05"], 
        "mid": ["中調 花香 01", "中調 花香 02", "中調 花香 19"], 
        "base": ["後調 木質 01", "後調 木質 08", "後調 木質 05"]
    },
    "INFP (調解者)": {
        "top": ["前調 芳香 03", "前調 芳香 02", "前調 柑橘 01"], 
        "mid": ["中調 花香 19", "中調 花香 03", "中調 果香 01"], 
        "base": ["後調 木質 13", "後調 木質 02", "後調 東方 02"]
    },
    "INFJ (提倡者)": {
        "top": ["前調 芳香 09", "前調 柑苔 04", "前調 芳香 05"], 
        "mid": ["中調 花香 04", "中調 花香 06", "中調 花香 14"], 
        "base": ["後調 木質 11", "後調 木質 06", "後調 東方 02"]
    },
    "ENFP (競選者)": {
        "top": ["前調 柑橘 04", "前調 柑橘 02", "前調 芳香 08"], 
        "mid": ["中調 果香 03", "中調 果香 04", "中調 花香 07"], 
        "base": ["後調 東方 06", "後調 東方 11", "後調 木質 13"]
    },
    "ENTJ (指揮官)": {
        "top": ["前調 芳香 04", "前調 柑苔 01", "前調 柑橘 03"], 
        "mid": ["中調 花香 11", "中調 果香 05", "中調 果香 01"], 
        "base": ["後調 東方 09", "後調 木質 08", "後調 東方 03"]
    },
    "ENTP (辯論家)": {
        "top": ["前調 柑橘 04", "前調 芳香 07", "前調 柑苔 03"], 
        "mid": ["中調 果香 07", "中調 果香 08", "中調 花香 17"], 
        "base": ["後調 東方 03", "後調 東方 09", "後調 木質 11"]
    },
    "ENFJ (主人公)": {
        "top": ["前調 柑橘 07", "前調 芳香 09", "前調 柑橘 05"], 
        "mid": ["中調 花香 05", "中調 花香 09", "中調 果香 06"], 
        "base": ["後調 木質 13", "後調 東方 08", "後調 木質 12"]
    },
    "ISTJ (物流師)": {
        "top": ["前調 芳香 06", "前調 柑苔 02", "前調 芳香 08"], 
        "mid": ["中調 花香 01", "中調 花香 08", "中調 果香 12"], 
        "base": ["後調 木質 05", "後調 木質 03", "後調 木質 10"]
    },
    "ISFJ (守衛者)": {
        "top": ["前調 柑橘 07", "前調 芳香 02", "前調 柑橘 01"], 
        "mid": ["中調 花香 09", "中調 花香 12", "中調 花香 18"], 
        "base": ["後調 木質 02", "後調 東方 08", "後調 木質 01"]
    },
    "ESTJ (總經理)": {
        "top": ["前調 芳香 02", "前調 柑橘 05", "前調 芳香 08"], 
        "mid": ["中調 花香 01", "中調 果香 11", "中調 果香 12"], 
        "base": ["後調 木質 03", "後調 木質 08", "後調 木質 10"]
    },
    "ESFJ (執政官)": {
        "top": ["前調 果香 03", "前調 柑橘 02", "前調 柑橘 01"], 
        "mid": ["中調 花香 14", "中調 花香 16", "中調 果香 10"], 
        "base": ["後調 東方 06", "後調 木質 13", "後調 東方 11"]
    },
    "ISTP (鑑賞家)": {
        "top": ["前調 芳香 07", "前調 柑苔 03", "前調 芳香 06"], 
        "mid": ["中調 果香 09", "中調 花香 08", "中調 果香 14"], 
        "base": ["後調 木質 06", "後調 木質 12", "後調 東方 02"]
    },
    "ISFP (探險家)": {
        "top": ["前調 柑橘 03", "前調 芳香 03", "前調 柑橘 06"], 
        "mid": ["中調 花香 07", "中調 果香 02", "中調 花香 03"], 
        "base": ["後調 木質 07", "後調 東方 05", "後調 木質 04"]
    },
    "ESTP (企業家)": {
        "top": ["前調 柑橘 04", "前調 柑苔 01", "前調 芳香 04"], 
        "mid": ["中調 果香 07", "中調 果香 08", "中調 果香 13"], 
        "base": ["後調 東方 07", "後調 東方 09", "後調 木質 12"]
    },
    "ESFP (表演者)": {
        "top": ["前調 柑橘 02", "前調 柑橘 04", "前調 果香 04"], 
        "mid": ["中調 花香 10", "中調 花香 13", "中調 果香 15"], 
        "base": ["後調 東方 11", "後調 東方 06", "後調 東方 01"]
    },
    "INTP (邏輯學家)": {
        "top": ["前調 芳香 01", "前調 芳香 09", "前調 柑苔 04"], 
        "mid": ["中調 果香 14", "中調 花香 06", "中調 果香 09"], 
        "base": ["後調 木質 06", "後調 木質 11", "後調 東方 02"]
    }
}

zodiac_scents = {
    "白羊座": {"top": "前調 柑橘 04", "reason": "葡萄柚的爆發力對應開拓者不熄的勇氣能量。"},
    "金牛座": {"top": "前調 芳香 05", "reason": "梔子花的細膩純淨，呼應您對感官品質與質感的追求。"},
    "雙子座": {"top": "前調 芳香 02", "reason": "羅勒與百里香的靈動，詮釋您跳躍的好奇心與思考速度。"},
    "巨蟹座": {"top": "前調 芳香 01", "reason": "清冷烏龍後的溫潤餘韻，營造出如家一般的歸屬與安全感。"},
    "獅子座": {"top": "前調 芳香 04", "reason": "馬郁蘭的肆意奔放，展現您天生的領導者魅力與創造力氣場。"},
    "處女座": {"top": "前調 芳香 06", "reason": "茶樹的清冽與純淨，呼應您對事物細節與完美的極致堅持。"},
    "天秤座": {"top": "前調 芳香 09", "reason": "綠茶的優雅清芬，助您達成內在靈魂與外在環境的極致平衡。"},
    "天蠍座": {"top": "前調 柑苔 01", "reason": "無花果木的深邃感，對應您神祕的直覺與強大的靈魂轉化力。"},
    "射手座": {"top": "前調 芳香 08", "reason": "馬鞭草的清爽跳躍，帶領靈魂追尋遠方不被束縛的絕對自由。"},
    "摩羯座": {"top": "前調 芳香 01", "reason": "沈穩結構的小豆蔻茶香，展現您踏實前行、值得信賴的責任感。"},
    "水瓶座": {"top": "前調 芳香 07", "reason": "極致清涼的薄荷，致敬您特立獨行、革新未來的人道主義靈魂。"},
    "雙魚座": {"top": "前調 芳香 03", "reason": "含羞草的夢幻粉感，讓您的藝術靈魂在夢境與現實間浪漫呼吸。"}
}

element_scents = {
    "水": {"base": "後調 東方 02"}, "木": {"base": "後調 木質 02"},
    "火": {"base": "後調 東方 06"}, "金": {"base": "後調 木質 05"}, "土": {"base": "後調 木質 08"}
}

model_logic = {
    "黃金平衡型 (20:35:45)": {"ratios": [0.20, 0.35, 0.45], "desc": "最穩定的結構，香氣銜接平滑。"},
    "清新爆發型 (40:35:25)": {"ratios": [0.40, 0.35, 0.25], "desc": "強化前調爆發力，適合清爽提神。"},
    "深邃留香型 (15:30:55)": {"ratios": [0.15, 0.30, 0.55], "desc": "加重後調比重，展現持久魅力。"}
}

perfume_logic = {
    "日常通勤": {"type": "EDT", "total_oil": 1.0}, "約會派對": {"type": "EDP", "total_oil": 1.5},
    "商務正式": {"type": "EDP", "total_oil": 1.2}, "運動休閒": {"type": "Cologne", "total_oil": 0.8},
    "冥想睡眠": {"type": "Mist", "total_oil": 0.6}
}

# ==========================================
# 核心函數
# ==========================================
def translate_scents(code_list):
    html_snippets = ""
    for i, code in enumerate(code_list):
        full_info = scent_map.get(code, f"{code} (專屬配方)")
        name = full_info.split(" (")[0] if " (" in full_info else full_info
        ing = "(" + full_info.split(" (")[1] if " (" in full_info else ""
        desc = scent_descriptions.get(code, "這款香氣能優雅平衡你的內在能量。")
        html_snippets += f"<div style='margin-bottom:8px; padding:10px; border-radius:10px; background:rgba(255,255,255,0.45); border:0.5px solid #eee;'><div style='color: #8B4513; font-weight: bold; font-size: 14px;'>建議: {name}</div><div style='font-size: 11px; color: #666;'>{ing}</div><div style='font-size: 10px; color: #9E7E6B; margin-top:4px;'><i>{desc}</i></div></div>"
    return html_snippets

def get_zodiac(m, d):
    signs = [(1,20,"摩羯座"),(2,19,"水瓶座"),(3,21,"雙魚座"),(4,20,"白羊座"),(5,21,"金牛座"),(6,22,"雙子座"),(7,23,"巨蟹座"),(8,23,"獅子座"),(9,23,"處女座"),(10,24,"天秤座"),(11,23,"天蠍座"),(12,22,"射手座"),(12,31,"摩羯座")]
    for mm, dd, s in signs:
        if m < mm or (m == mm and d <= dd): return s
    return "摩羯座"

def get_life_num(bday):
    d = "".join(filter(str.isdigit, str(bday)))
    while len(d) > 1: d = str(sum(int(x) for x in d))
    return d

def get_chinese_zodiac(year):
    animals = ["猴", "雞", "狗", "豬", "鼠", "牛", "虎", "兔", "龍", "蛇", "馬", "羊"]
    return animals[year % 12]

# ==========================================
# 分頁控制邏輯 (Step-by-Step)
# ==========================================
st.title("🧪 Aroma's Secret Lab")

if "step" not in st.session_state:
    st.session_state.step = 1

# 進度條
progress_map = {1: 0.25, 2: 0.5, 3: 0.75, 4: 1.0}
st.progress(progress_map.get(st.session_state.step, 1.0))

# --- Step 1: 命運基盤 ---
if st.session_state.step == 1:
    st.subheader("Step 1: 🌌 命運基盤能量")
    st.info("AI 將根據您的出生時刻，定位星盤坐標與生肖五行能量。")
    st.session_state.birthday = st.date_input("📅 您的出生年月日", value=date(2000, 1, 1), key="step1_birthday")
    if st.button("下一步：探索性格基因 ➔"):
        st.session_state.step = 2
        st.rerun()

# --- Step 2: 性格基因 ---
elif st.session_state.step == 2:
    st.subheader("Step 2: 🧠 內在性格基因")
    st.info("性格影響香味的中調選擇，這是香水的靈魂核心。")
    st.session_state.mbti_choice = st.selectbox("🧠 您的 MBTI 人格", list(mbti_db.keys()), key="step2_mbti")
    
    col1, col2 = st.columns(2)
    with col1:
        if st.button("⬅ 返回上一步"):
            st.session_state.step = 1
            st.rerun()
    with col2:
        if st.button("下一步：氣味場景建模 ➔"):
            st.session_state.step = 3
            st.rerun()

# --- Step 3: 氣味建模 ---
elif st.session_state.step == 3:
    st.subheader("Step 3: 📐 氣味場景建模")
    st.info("選擇使用的場合與您偏好的香氣結構。")
    st.session_state.occasion = st.selectbox("🏙️ 預計使用場合", list(perfume_logic.keys()), key="step3_occ")
    st.session_state.selected_model = st.selectbox("📐 香氣結構模型", list(model_logic.keys()), key="step3_model")
    
    col1, col2 = st.columns(2)
    with col1:
        if st.button("⬅ 返回上一步"):
            st.session_state.step = 2
            st.rerun()
    with col2:
        if st.button("🔮 啟動 AI 深度分析"):
            st.session_state.step = 4
            st.rerun()

# --- Step 4: 結果展示 ---
elif st.session_state.step == 4:
    # 判斷是否已經運行過載入動畫
    if "done_loading" not in st.session_state:
        progress_bar = st.progress(0)
        status_text = st.empty()
        loading_steps = [
            {"text": "🌌 正在調取星盤坐標，對齊黃道十二宮脈絡...", "t": 1.2},
            {"text": "🏮 讀取生肖命理，計算五行能量流動...", "t": 1.0},
            {"text": "🧪 正在從氣味庫中篩選靈魂氣味基因...", "t": 1.5},
            {"text": "🧠 匹配人格核心，排除分子排斥反應...", "t": 1.3},
            {"text": "⚖️ 正在校準最佳 10ml 調配滴數...", "t": 0.8}
        ]
        for i, step in enumerate(loading_steps):
            status_text.markdown(f"**{step['text']}**")
            time.sleep(step['t'])
            progress_bar.progress((i + 1) / len(loading_steps))
        
        status_text.empty()
        progress_bar.empty()
        st.session_state.done_loading = True
        st.rerun()

    # 執行實際運算
    birthday = st.session_state.birthday
    mbti_choice = st.session_state.mbti_choice
    occasion = st.session_state.occasion
    selected_model = st.session_state.selected_model

    z_name = get_zodiac(birthday.month, birthday.day)
    c_zodiac = get_chinese_zodiac(birthday.year)
    c_element = zodiac_elements[c_zodiac]
    l_num = get_life_num(birthday)

    res = mbti_db[mbti_choice]
    occ_data = perfume_logic[occasion]
    model_data = model_logic[selected_model]
    z_scent = zodiac_scents.get(z_name, {"top": "前調 芳香 01", "reason": "能量引導"})
    e_data = element_scents.get(c_element, {"base": "後調 木質 08"})

    # 去重並限制 3 個
    final_top = list(dict.fromkeys([z_scent["top"]] + res['top']))[:3]
    final_mid = list(dict.fromkeys(res['mid']))[:3]
    final_base = list(dict.fromkeys([e_data["base"]] + res['base']))[:3]

    # 渲染卡片
    st.markdown(f"""
    <div style="background: white; padding: 25px; border-radius: 20px; border: 2px solid #1a1a1a; box-shadow: 8px 8px 0px #F5F5F5; color: #333;">
        <h2 style="text-align:center; color:#8B4513;">🧬 AI 全維度專屬配方</h2>
        <div style="display:flex; justify-content:center; gap:10px; margin:15px 0;">
            <span style="background:#E3F2FD; padding:4px 10px; border-radius:10px; font-size:11px;">🌠 {z_name}</span>
            <span style="background:#F3E5F5; padding:4px 10px; border-radius:10px; font-size:11px;">🏮 {c_zodiac}({c_element})</span>
            <span style="background:#E8F5E9; padding:4px 10px; border-radius:10px; font-size:11px;">🔢 靈數 {l_num}</span>
        </div>
        <div style="font-size: 12px; color: #4A5568; line-height: 1.6; background: #FAFAFA; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 0.5px solid #EDF2F7;">
            <p style="margin:0 0 10px 0;"><b>✨ 星座特質：</b>{zodiac_db.get(z_name, "能量引導者")}</p>
            <p style="margin:0;"><b>☯️ 五行能量：</b>{element_traits.get(c_element, "穩定底蘊")}</p>
        </div>
        <div style="background:#FFF9F0; padding:10px; border-radius:10px; border-left: 5px solid #D4AF37;">
            <p style="font-weight:bold; margin:0;">【前調建議】</p>{translate_scents(final_top)}
            <p style="font-weight:bold; margin:10px 0 0 0;">【中調建議】</p>{translate_scents(final_mid)}
            <p style="font-weight:bold; margin:10px 0 0 0;">【後調建議】</p>{translate_scents(final_base)}
        </div>
    </div>
    """, unsafe_allow_html=True)

    # 配比顯示
    st.write("---")
    st.subheader(f"🧪 專業配比建議：{selected_model}")
    r, total, df = model_data["ratios"], occ_data["total_oil"], 25
    c1, c2, c3 = st.columns(3)
    c1.metric("前調", f"{round(total*r[0],2)}ml", f"{round(total*r[0]*df)}滴")
    c2.metric("中調", f"{round(total*r[1],2)}ml", f"{round(total*r[1]*df)}滴")
    c3.metric("後調", f"{round(total*r[2],2)}ml", f"{round(total*r[2]*df)}滴")

    st.balloons()
    if st.button("🔄 重新開始分析"):
        st.session_state.clear()
        st.rerun()
